{% extends "base.html" %}
{% load staticfiles %}
{% load thumbnail %}
{% load helper %}

{% block body %}
{{block.super}}
<div class="content">
	{% if msg %}
		<span class="message">{{msg}}</span>
	{% else %}

	<div class="headline">
		{% if match.game.icon %}
		<img src="{{ match.game.icon|thumbnail_url:'game_site' }}" />
		{% else %}
		<h1 class="game_headline">{{ match.game.name }}</h1>
		{% endif %}
	</div>
	<div class="match_info">
		<div class="datetime">
			<div class="game_info_time">
				<h5 class="row_info">Datum</h5>
				{% if match.datetime.date %}
					<h4 class="game_info">{{ match.datetime.date }}</h4>
				{% else %}
					<h4 class="game_info">-</h4>
				{% endif %}
			</div>
			<div class="game_info_time">
				<h5 class="row_info">Uhrzeit</h5>
				{% if match.datetime.time %}
					<h4 class="game_info">{{ match.datetime.time }}</h4>
				{% else %}
					<h4 class="game_info">-</h4>
				{% endif %}
			</div>
		</div>

		<div class="game_mode">
			<h5 class="row_info">Spielmodus</h5>
			{% if match.game_mode %}
				<h4 class="game_info">{{ match.game_mode }}</h4>
			{% else %}
				<h4 class="game_info">-</h4>
			{% endif %}
		</div>
		
		<div class="description">
			<h5 class="row_info">Beschreibung</h5>
			{% if match.description %}
				<h4 class="game_info">{{ match.description }}</h4>
			{% else %}
				<h4 class="game_info">-</h4>
			{% endif %}
		</div>
		
		<div class="player">
			<h5 class="row_info">Spieler pro Team</h5>
			<h4 class="game_info">{{ match.player_per_team }}</h4>
		</div>

		<div class="rules">
			<h5 class="row_info">Regeln</h5>
			{% if match.rules %}
				{% for rule in match.rules.splitlines %}
					<h4 class="game_info">{{ rule }}</h4>
				{% endfor %}
			{% else %}
				<h4 class="game_info">-</h4>
			{% endif %}
		</div>

		<div class="user">
			<h5 class="row_info">Angemeldete Benutzer</h5>
			<ul>
			{% for user in match.user.all %}
	 		<li class="user_list">{{ user }}</li>
			{% endfor %}
			</ul>

			{% if not match.team_match.all %}
				<form method="post" action="register_user/">
					{% csrf_token %}
					<input type="submit" class="match_register" type="submit" value="{{ match|button_label:user }}" />
					<input type="hidden" name="match_id" value="{{match.id}}" />
				</form>
			{% endif %}
		</div>
	</div>

	{% if match.team_choose_type == "self" and match.playerWithoutTeam %}
	<div class="choose_team">
		<div class="player_pool">
			{% if user in match.playerWithoutTeam %}
			<form method="post" class="create_self_team" action="create_self_team/">
			{% else %}
			<form method="post" class="create_self_team" action="update_self_team/">
			{% endif %}
				{% csrf_token %}
				{% for player in match.playerWithoutTeam %}
					<input type="checkbox" id="user_{{player.id}}" name="create_self_team" value="{{player.id}}" 
					{% if user == player %}
					checked disabled
					{% endif %}
					 />
					<label for="user_{{player.id}}">{{ player }}</label>
				{% endfor %}
				<input type="submit" type="submit" value="{{ match|button_label_self_team:user }}" />
				<input type="hidden" name="match_id" value="{{match.id}}" />
			</form>
		</div>
	</div>
	{% endif %}

	{% if match.team_choose_type == "admin" and match.playerWithoutTeam %}
	{% if user|has_group:"Admin" %}
	<div class="choose_team">
		<div class="player_pool">
			<form method="post" class="create_admin_team" action="create_admin_team/">
				{% csrf_token %}
				{% for user in match.playerWithoutTeam %}
					<input type="checkbox" id="user_{{user.id}}" name="create_admin_team" value="{{user.id}}" />
					<label for="user_{{user.id}}">{{ user }}</label>
				{% endfor %}
				<input type="submit" type="submit" value="Team erstellen" />
				<input type="hidden" name="match_id" value="{{match.id}}" />
			</form>
		</div>
	</div>
	{% endif %}
	{% endif %}

	<div class="teams">
		{% if match.team_match.all %}
			<h2>Teams</h2>
			{% for team in match.team_match.all %}
				{% ifequal forloop.counter0|modulo:3 0 %}
				<div class="team_row">
				{% endifequal %}
					<div class="team" id="team_id_{{team.id}}">
						<h4>Team {{team.description}}</h4>
						<ul>
							{% for user in team.user.all %}
							<li>{{ user }}</li>
							{% endfor %}
						</ul>
						{% if not match.round_match.all and user|has_group:"Admin" %}
						<form method="post" class="delete_team" action="delete_team/">
							{% csrf_token %}
							<input type="submit" type="submit" value="X" />
							<input type="hidden" name="team_id" value="{{team.id}}" />
						</form>
						{% endif %}
					</div>
				{% if forloop.counter0|modulo:3 == 2 or forloop.last %}
					</div>
				{% endif %}
			{% endfor %}
		{% endif %}
	</div>

	{% if match.tour_choose_type == "vs" %}
		{% if match.round_match.all %}
		<div class="tournament_rounds">
			<h2>Begegnungen</h2>
			<table class"rounds">
				<tr>
					<th>Runde</th>
					<th>Uhrzeit</th>
					<th>Team (Home)</th>
					<th>Punkte (Home)</th>
					<th>Punkte (Away)</th>
					<th>Team (Away)</th>
				</tr>
				{% for round in match.round_match.all %}
				<tr>
					<form method="post" class="single_round_form" action="entry_round_result/">
						{% csrf_token %}
						<th>{{ round.round_number }}</th>
						<td>{{ round.getDatetime }}</td>
						<td>{{ round.team1.getTeam }}</td>
						<td><input type="text" maxlength="3" size="3" name="pkt1" value="{{ round.getPkt1 }}" autocomplete="off" /></td>
						<td><input type="text" maxlength="3" size="3" name="pkt2" value="{{ round.getPkt2 }}" autocomplete="off" /></td>
						<td>{{ round.team2.getTeam }}</td>
						<td>
							<input type="submit" type="submit" value="Okay" />
							<input type="hidden" name="round_id" value="{{ round.id }}" />
						</td>
					</form>
				</tr>
				{% endfor %}
			</table>
		</div>

		<div class="ranking">
			<h2>Ranking</h2>
			<table>
				<tr>
					<th>Teams</th>
					<th>Siege</th>
					<th>Punkte</th>
				</tr>
				{% for team in match.team_match.all|sortTeam %}
				<tr>
					<td>Team {{ team.0.description }}</td>
					<td>{{ team.1.wins }}</td>
					<td>{{ team.1.pts }}</td>
				</tr>
				{% endfor %}
			</table>
		</div>
		{% endif %}
	{% elif match.tour_choose_type == "tree" %}
		<div id="tournamen_tree">
			<h2>Turnierbaum</h2>
			<div id="tournament_tree_teams">


			{% with counter=match.round_match.count n=match.round_match.count|devide:"2" round_number=1 %}
				{% if counter == n %}
					{% set n = n|devide:"2" %}
					{{ round_number|add:"1" }}
				{% endif %}
				{{ counter = counter|add:"-1" }}
			{% endwith %}
				{% for round in match.round_match.all %}
					<input type="hidden" data-match="{{match.id}}" data-round="{{forloop.counter}}" class="tournament_tree_team" value="{{round.getTeams}}"/>

					<input type="hidden" data-match="{{match.id}}" data-round="{{forloop.counter}}" class="tournament_tree_points" value="{{round.getPoints}}"/>
				{% endfor %}
			</div>
			<div id="tournamen_tree_content"></div>
		</div>
	{% endif %}

	{% if user|has_group:"Admin" %}
	<div class="admin_interface">
		<form method="post" class="create_team" action="create_teams/">
			{% csrf_token %}
			<input type="radio" id="create_team_random" name="create_team_type" value="random" {{ match|radioCheckedTeam:"rand" }} />
			<label for="create_team_random">Zufall</label>
			<input type="radio" id="create_team_self" name="create_team_type" value="self" {{ match|radioCheckedTeam:"self" }} />
			<label for="create_team_self">Eigene Wahl</label>
			<input type="radio" id="create_team_admin" name="create_team_type" value="admin" {{ match|radioCheckedTeam:"admin" }} />
			<label for="create_team_admin">Admin Wahl</label>
			<input type="submit" type="submit" value="Teams erstellen" />
			<input type="hidden" name="match_id" value="{{match.id}}" />
		</form>

		<form method="post" class="create_tournament" action="create_tournament/">
			{% csrf_token %}
			<input type="radio" id="create_tour_vs" name="create_tour" value="vs" {{ match|radioCheckedTour:"vs" }} />
			<label for="create_tour_vs">Jeder gegen Jeden</label>
			<input type="radio" id="create_tour_tree" name="create_tour" value="tree" {{ match|radioCheckedTour:"tree" }} />
			<label for="create_tour_tree">Turnierbaum</label>
			<input type="checkbox" id="create_tour_tree_loserbracket" name="create_tour_tree_loserbracket" disabled/>
			<label for="create_tour_tree_loserbracket">Loserbracket</label>
			<input type="submit" type="submit" value="Turnier erstellen" />
			<input type="hidden" name="match_id" value="{{ match.id }}" />
		</form>

		<form method="post" class="delete_tournament" action="delete_tournament/">
			{% csrf_token %}
			<input type="submit" type="submit" value="Turnier lÃ¶schen" />
			<input type="hidden" name="match_id" value="{{ match.id }}" />
		</form>
	</div>
	{% endif %}
	
	{% endif %}
</div>
{% endblock %}